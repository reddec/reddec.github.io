<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catch game</title>

    <style type="text/css" media="screen">
        #editor {
            min-height: 600px;
            min-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
<div class="grid-container fluid">
    <div class="grid-x grid-margin-x">
        <div class="shrink cell">
            <div id="result"></div>
            <canvas id="canvas" width="800" height="600"></canvas>
        </div>
        <div class="auto cell">
            <button style="float: left" onclick="start()" class="button primary">Start</button>
            <div id="editor"> /* this.fx - force by X, this.fy - force by Y, this.step - step number */
            </div>
        </div>
    </div>
</div>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/css/foundation.min.css"/>
</body>
<script src="build.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.9/ace.js"></script>


<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/chrome");
    editor.getSession().setMode("ace/mode/javascript");
</script>
<script>
    var elem = document.getElementById("canvas");
    var center = new Point(elem.width / 2, elem.height / 2);
    var engine = new Engine(elem);
    var timer;
    var planetRadius = 30, rocketRadius = 10, targetRadius = 20;
    var planet, rocket, rocketEngine;
    var target, planetBorder;
    var tracer;
    var userLogic;

    function rocketLogic(step) {
        var ctx = {
            fx: 0,
            fy: 0,
            step: step
        };
        userLogic.bind(ctx)();
        return new Point(ctx.fx, ctx.fy);
    }

    function gameSuccess(items) {
        clearInterval(timer);
        document.getElementById("result").innerHTML = '<h1 style="color: green">Success!</h1>';
    }

    function gameFail(items) {
        clearInterval(timer);
        document.getElementById("result").innerHTML = '<h1 style="color: red">Fail :-(</h1>';
    }


    function initEnvironment() {
        planet = new StaticRadioEmission(10000, center);
        rocket = new MassObject(20, center.right(100).bottom(100));
        rocketEngine = new SmartEngine(rocket, rocketLogic);
        target = new RadialSingleSpot(center.left(120).top(70), gameSuccess, targetRadius + rocketRadius, [rocket]);
        planetBorder = new RadialSingleSpot(planet.at, gameFail, planetRadius + rocketRadius, [rocket]);
        tracer = new Tracer(rocket);
        engine.items.push(planet, rocket, target, planetBorder, tracer);
    }

    function initLinks() {
        engine.items.push(new ForceLink([rocket], [planet]));
    }

    function initUI() {
        engine.visuals.push(
            new Grid(50, '#eeeeee'),
            new Path(tracer),
            new Circle(planet, planetRadius, '#00ff00'),
            new Circle(target, targetRadius, '#0000ff'),
            new Rocket(rocket, rocketEngine, rocketRadius),
            new DynamicLabel(new Point(20, 20), function () {
                return 'Step: ' + engine.currentStep;
            }),
            new DynamicLabel(new Point(20, 45), function () {
                return 'Fuel: ' + rocketEngine.usedPower.toFixed(3);
            })
        );
    }

    function start() {
        document.getElementById("result").innerHTML = '';
        clearInterval(timer);
        engine = new Engine(elem);
        initEnvironment();
        initLinks();
        initUI();

        userLogic = new Function(editor.getValue());
        engine.items.push(rocketEngine);
        timer = setInterval(function () {
            engine.update();
        }, 41);
    }

    initEnvironment();
    initLinks();
    initUI();
    engine.update();

</script>
</html>